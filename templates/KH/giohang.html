{% load static %}
{% load filter %}
<!DOCTYPE html>
<html lang="en">
<head>
<!-- basic -->
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- mobile metas -->
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="viewport" content="initial-scale=1, maximum-scale=1">
<!-- site metas -->
<title>Giỏ hàng</title>
<meta name="keywords" content="">
<meta name="description" content="">
<meta name="author" content="">
<!-- bootstrap css -->
<link rel="stylesheet" type="text/css" href="{% static 'uloax/css/bootstrap.min.css' %}">
<!-- style css -->
<link rel="stylesheet" type="text/css" href="{% static 'uloax/css/style.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'uloax/css/style1.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'uloax/css/searching.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'uloax/css/lichtrinh.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'uloax/css/cart.css' %}">
<!-- Fontawesome -->
<link rel="stylesheet" href="{% static 'uloax/css/fontawesome-all.min.css' %}">
<!-- Responsive-->
<link rel="stylesheet" href="{% static 'uloax/css/responsive.css' %}">
<!-- fevicon -->
<link rel="icon" href="{% static 'uloax/images/fevicon.png' %}" type="image/gif" />
<!-- Scrollbar Custom CSS -->
<link rel="stylesheet" href="{% static 'uloax/css/jquery.mCustomScrollbar.min.css' %}">
<!-- Tweaks for older IEs-->
<!--<link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">-->
<!-- owl stylesheets -->
<link rel="stylesheet" href="{% static 'uloax/css/owl.carousel.min.css' %}">
<!--<link rel="stylesheet" href="{% static 'uloax/css/owl.theme.default.min.css' %}">-->
<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css" media="screen">-->

</head>
<body>
	<!--header section start -->
    <div id="index.html" class="header_section">
        <div class="container">
            <div class="row">
                <div class="col-sm-6 col-lg-3">
                    <div class="logo"><a style="font-size: 30px;" href="index.html"><img style="width: 30%;" src="{% static 'uloax/images/bus-icon.png' %}"><b style="font-family: Helvetica; color: #fff"> BUS </b></a>
                    </div>
                </div>
                <div class="col-sm-6 col-lg-9">
                    <div class="menu_text">
                        <ul>
                            <li><a href="../../../">Trang chủ</a></li>
                            <li><a href="../../../bus_route">Lịch trình</a></li>
                            <li><a href="../../../bus_stop">Bến xe</a></li>
                            <li><a href="#booking">Hướng dẫn đặt vé</a></li>
                            <li><a href="#contact">Liên hệ</a></li>
                            <li><a href="#"><img style="width: 23px; height: 23px;" src="{% static 'uloax/images/cart-icon.png' %}">
                                <span class='badge badge-warning slve' id='lblCartCount'> {{sove}} </span>
                            </a></li>
                            <div class="position-absolute top-0 end-0 btn-tk" style="padding-top: 10px;">
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" style="border: 1px solid #f4c22b;" href="#" id="navbarDarkDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i style="padding-right: 10px;" href="#" class="feather icon-user"></i>{{tk}}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="navbarDarkDropdownMenuLink" style="background-color: #fff; top: 100%; padding-top: 5px; padding-bottom: 5px;">
                            <li><a class="dropdown-item" style = "text-transform: none; font-weight: 600; color: #323437;" href="../thongtin">Thông tin cá nhân</a></li>
                            <li><a class="dropdown-item" style = "text-transform: none; font-weight: 600; color: #323437;" href="../../../customer/ticket">Vé đã đặt</a></li>
                            <li><a class="dropdown-item" style = "text-transform: none; font-weight: 600; color: #323437;" href="../../../logout">Đăng xuất</a></li>
                        </ul>
                    </div>
                </div>
                            <div id="myNav" class="overlay">
                               <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
                                <div class="overlay-content">
                                   <div class="TK">
                                      <a id="showHome" style="color: #fff" onclick="showHome()" >
                                         <i style="padding-right: 10px;" href="#" class="fa fa-home"></i>Trang chủ
                                      </a>
                                      <div>
                                        <ul aria-labelledby="dropdownMenuButton1">
                                            <li class="showH"><a href="../../../bus_route">Lịch trình</a></li>
                                            <li class="showH"><a href="../../../bus_stop">Bến xe</a></li>
                                            <li class="showH"><a href="#">Giỏ hàng</a></li>
                                            <li class="showH"><a href="#">Hướng dẫn đặt vé</a></li>
                                            <li class="showH" style="padding-bottom: 20px; border-bottom: 1px solid;"><a href="#">Liên hệ</a></li>
                                        </ul>
                                      </div>
                                   </div>
                                   <div class="TK">
                                      <a id="showKH" style="color: #fff" onclick="showKH()">
                                         <i style="padding-right: 10px;" href="#" class="fa fa-user"></i>Thông tin cá nhân
                                      </a>
                                      <div>
                                        <ul aria-labelledby="dropdownMenuButton1">
                                           <li class="showKH"><a href="../../../customer/ticket">Vé đã đặt</a></li>
                                           <li class="showKH"><a href="../../../logout">Đăng xuất</a></li>
                                        </ul>
                                      </div>
                                   </div>
                               </div>
                            </div>
                            <span  style="font-size:33px;cursor:pointer; color: #ffffff;" onclick="openNav()"><img style="width: 20px;" src="{% static 'uloax/images/toggle-menu.png' %}" class="toggle_menu"></span>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <!-- header section end -->
    <!-- breadcrumb start -->
    <div class="container">
        <nav class="brd" aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="#">
                    <i style="color: blue;" class="feather icon-home"></i>
                </a>
            </li>
            <li class="breadcrumb-item active">
                Giỏ hàng
            </li>
        </ol>
    </nav>
    </div>
    <!-- breadcrumb start -->

    <!-- content start -->
    <div class="content" style="padding: 20px;" id="div_table">
        <form method="post" id="form_tt">
            {% csrf_token %}
            <div class="container">
            <div class="card Recent-Users">
                <div class="col-lg-12 col-md-12 col-12">
            <h3 class="display-5 mb-2 text-center">Giỏ hàng</h3>
            <p class="mb-5 text-center">
                <i class="text-info font-weight-bold slve" id="sv">{{sove}}</i> vé trong giỏ hàng của bạn</p>
            <table id="shoppingCart" class="table table-condensed table-responsive">
                <thead>
                    <tr>
                        <th>
<!--                            <div class="form-check">-->
<!--                                <input class="form-check-input cb" style="margin-top: .6rem;" type="checkbox" id="all"> All-->
<!--                            </div>-->
                        </th>
                        <th style="width:50%">Vé xe</th>
                        <th style="width:65%">Chi tiết</th>
                        <th style="width:12%">Giá</th>
                        <th style="width:10%">Số lượng</th>
                        <th style="width:16%"></th>
                    </tr>
                </thead>
                <tbody>
                   {% for k in data %}
                    <tr class="h">
                        <td>
                            <div class="form-check">
                                <input class="form-check-input cb checkBoxClass mlt" type="checkbox" id="flexCheckDefault" name="mlt" value="{{k|mongo_id}}">
                            </div>
                        </td>
                        <td data-th="Product" style="white-space: normal;">
                            <div class="row">
                                <div class="col-md-3 text-left">
                                    <img src="{% static 'uloax/images/ticket.jpg' %}" alt="" class="img-fluid d-none d-md-block rounded mb-2 shadow ">
                                </div>
                                <div class="col-md-9 text-left mt-sm-2">
                                    <h4>{{k.TramDau.TenDuong}} - {{k.TramCuoi.TenDuong}}</h4>
                                    <p class="font-weight-light">{{k.TGXB}} - {{k.TGDB}}</p>
                                </div>
                            </div>
                        </td>
                        <td data-th="LoTrinh" style="white-space: normal;">
                            {% for tr in k.Tram %}
                            - {{tr.TenDuong}}
                            {% endfor %} -
                        </td>
                        <td data-th="Price" class="gia" name="gia">{{k.MaTuyen.0.GiaVe}}</td>
                        <td data-th="Quantity">
                            <input type="number" style="width: 120%;{%if k.MaTuyen.0.SoVe < k.SL %}color: red; font-weight: 700;{%endif%}" class="form-control form-control-lg text-center sl" name="soluong" value="{{k.SL}}">
                        </td>
                        <td>/<b class="vecosan">{{k.SoVe}}</b></td>
                        <td class="actions" data-th="">
                            <div class="text-right">
<!--                                <button class="btn btn-white border-secondary bg-white btn-md mb-2">-->
<!--                                    <i class="fas fa-sync"></i>-->
<!--                                </button>-->
                                <button type="submit" class="delete" value="{{k|mongo_id}}" class="btn btn-white border-secondary bg-white btn-md mb-2">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                   {% endfor %}
                </tbody>
            </table>
            <div class="float-right text-right">
                <h4>Tổng tiền (VND):</h4>
                <h1 id="tong" > 0 </h1>
            </div>
           </div>
            </div>
            <button type="submit" formaction="../../customer/thanhtoan" name="tt" id="thanhtoan" style="float: right;" class="btn btn-primary btn-lg">Thanh toán</button>
        </div>
        </form>
    </div>
    <!-- content end -->
  <!-- section footer start -->
    <div class="section_footer ">
      <div class="container"> 
          <div class="footer_section_2">
            <div class="row">
                <div class="col-sm-6 col-md-6 col-lg-3">
                  <h2 class="account_text">Địa chỉ</h2>
                  <p class="ipsum_text">Tòa nhà số 01ABC, Nguyễn Trãi, TP Cần Thơ</p>
                </div>
                <div class="col-sm-6 col-md-6 col-lg-3">
                  <h2 class="account_text">Liên kết</h2>
                  <div class="image-icon"><img src="{% static 'uloax/images/bulit-icon.png' %}"><span class="fb_text"><a href="#">Trang chủ</a></span></div>
                <div class="image-icon"><img src="{% static 'uloax/images/bulit-icon.png' %}"><span class="fb_text"><a href="#">Lịch trình</a></span></div>
                <div class="image-icon"><img src="{% static 'uloax/images/bulit-icon.png' %}"><span class="fb_text"><a href="#">Bến xe</a></span></div>
                <div class="image-icon"><img src="{% static 'uloax/images/bulit-icon.png' %}"><span class="fb_text"><a href="#">Hướng dẫn đặt vé</a></span></div>
                <div class="image-icon"><img src="{% static 'uloax/images/bulit-icon.png' %}"><span class="fb_text"><a href="#">Liên hệ</a></span></div>
                </div>
                <div class="col-sm-6 col-md-6 col-lg-3">
                <h2 class="account_text">Liên hệ</h2>
                <div class="image-icon"><img src="{% static 'uloax/images/fb-icon.png' %}"><span class="fb_text"><a href="#">Facebook</a></span></div>
                <div class="image-icon"><img src="{% static 'uloax/images/twitter-icon.png' %}"><span class="fb_text"><a href="#">Twitter</a></span></div>
                <div class="image-icon"><img src="{% static 'uloax/images/in-icon.png' %}"><span class="fb_text"><a href="#">Linkedin</a></span></div>
                <div class="image-icon"><img src="{% static 'uloax/images/youtube-icon.png' %}"><span class="fb_text"><a href="#">Youtube</a></span></div>
                <div class="image-icon"><img src="{% static 'uloax/images/instagram-icon.png' %}"><span class="fb_text"><a href="#">Instagram</a></span></div>
                </div>
          <div class="col-sm-6 col-md-6 col-lg-3">
            <h2 class="adderess_text">Newsletter</h2>
            <input type="" class="email_text" placeholder="Enter Your Email" name="Enter Your Email">
            <button class="subscribr_bt">SUBSCRIBE</button>
          </div>
          </div>
          </div>
          </div>
      </div>
    </div>
    <dialog id="dialog" class="mdl-dialog" style="background-color: #000000b3; border: none; border-radius: 5px; display: none;">
       <h3 class="mdl-dialog__title" style="color: white; font-size: 16px;">Xóa vé xe thành công</h3>
    </dialog>
  <!-- section footer end -->
  <!-- copyright section start -->
  <div class="copyright_section">
    <div class="container">
      <p class="copyright">2019 All Rights Reserved. <a href="https://html.design">Free html  Templates</a></p>
    </div>
  </div>

    <!-- Javascript files-->
    <script src="{% static 'uloax/js/jquery.min.js' %}"></script>
    <script src="{% static 'uloax/js/popper.min.js' %}"></script>
    <script src="{% static 'uloax/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'uloax/js/jquery-3.0.0.min.js' %}"></script>
    <script src="{% static 'uloax/js/plugin.js' %}"></script>
    <!-- sidebar -->
    <script src="{% static 'uloax/js/jquery.mCustomScrollbar.concat.min.js' %}"></script>
    <script src="{% static 'uloax/js/custom.js' %}"></script>
    <!-- javascript --> 
<!--    <script src="{% static 'uloax/js/owl.carousel.js' %}"></script>-->
    <script src="https:cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script>
    $(document).ready(function(){
    $(".fancybox").fancybox({
    openEffect: "none",
    closeEffect: "none"
    });
       
    $(".zoom").hover(function(){
         
    $(this).addClass('transition');
    }, function(){
         
    $(this).removeClass('transition');
    });
    });
    </script> 
    <script>
    function openNav() {
    document.getElementById("myNav").style.width = "100%";
    }

    function closeNav() {
   document.getElementById("myNav").style.width = "0%";
   }

   function showKH() {
        x = document.querySelectorAll(".showKH");
        ul = document.getElementById("showKH");
        var ds = x[0].style.display;
        if (ds == "none") {
           ul.classList.add("open");
           for (i = 0; i < x.length; i++) {
           x[i].style.display = "block";
            }
        } else {
           ul.classList.remove("open");
           for (i = 0; i < x.length; i++) {
           x[i].style.display = "none";
            }
        }
   }
   function showHome() {
        x = document.querySelectorAll(".showH");
        ul = document.getElementById("showHome");
        var ds = x[0].style.display;
        if (ds == "none") {
           ul.classList.add("open");
           for (i = 0; i < x.length; i++) {
           x[i].style.display = "block";
            }
        } else {
           ul.classList.remove("open");
           for (i = 0; i < x.length; i++) {
           x[i].style.display = "none";
            }
        }
   }
</script>

    <script>
        let data = [];
        var $t = $("table > tbody > tr");
        var demo = $("#lblCartCount");
        var sv = $("#sv");
        var tong = $("#tong");
        $(".delete").click(function (e) {
            let mlt = $(this).val();
            e.preventDefault();
            // POST AJAX request
            $.ajax({
               type: 'POST',
               url: "../../customer/delete_item/" + mlt,
               success: function (response) {
                  $("tbody").load("get_tb");
                    demo.html(response["sove"])
                    sv.html(response["sove"])
               },
               error: function (response) {
                  console.log(response)
               }
            }).done(function(response) {

            });
        });
        $(".sl").change(function () {
              tr = $(this).parent().parent();
              mlt = tr.find(".mlt");
              let lt = mlt.val();
              let sl = $(this).val();
              var tr1 = $(this).parent().parent();
              var $checkbox = tr1.find('.mlt');
              var $td = tr1.find('td');
              let sl_cb = $(this).val();
              var gia = tr1.find('.gia').text();
              var vecosan = tr.find('.vecosan').text();
              vecosan = parseInt(vecosan, 10);
              if (sl <= vecosan) {
                 if (sl == 0)
                {
                    $td.remove();
                }
                 if ($checkbox.is(':checked'))
               {
                 var tongtien = 0;
                 tongtien = tongtien + gia*sl_cb;
                 tong.html(tongtien);
               }
               $.ajax({
                 url: "update_cart",
                 method: 'POST',
                 data : {
                    'mlt': lt,
                    'sl': sl
                 },
                 success: function (response) {
                     sove = response['sove'];
                     $(".slve").html(sove);
                 },
                 error: function (response) {
                 console.log(response);
                 }
               });
              }
              else {
                 alert('Số vé đã vượt qua số lượng có sẵn!');
                 $(this).val(vecosan);
                 sl = $(this).val();
                 $.ajax({
                 url: "update_cart",
                 method: 'POST',
                 data : {
                    'mlt': lt,
                    'sl': sl
                 },
                 success: function (response) {
                     sove = response['sove'];
                     $(".slve").html(sove);
                 },
                 error: function (response) {
                 console.log(response);
                 }
               });
              }

        });

        $("#thanhtoan").click(function (e) {
            var thanhtoan = $("#tong").text();
            $(this).attr('value', thanhtoan);
        });


    </script>
    <script>
var tongtien = 0;
function notify() {
      var tr = $(this).parent().parent().parent();
      var td = tr.find('td');
      var sl = td.find('.sl').val();
      var vecosan = tr.find('.vecosan').text();
      vecosan = parseInt(vecosan, 10);
      var gia = tr.find('.gia').text();
      var tong = $("#tong");
      if (sl <= vecosan) {
         if ($(this).is(':checked'))
        {
         tongtien = tongtien + gia*sl;
         tong.html(tongtien);
        }
        else {
          if (tongtien>0) {
             tongtien = tongtien - gia*sl;
          }
          tong.html(tongtien);
        }
      }
      else {
         $(this).prop('checked', false);
         alert('Số lượng vé không được nhiều hơn vé có sẵn');
      }
    };
$(".cb").on("click", notify);
</script>
</body>
</html>